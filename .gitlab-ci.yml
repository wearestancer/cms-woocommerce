
workflow:
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - when: always


variables:
  DOCKER_REGISTRY: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/wearestancer
  PHP_VERSION: "7.4"


.svn-publish:
  stage: deploy

  image: ${DOCKER_REGISTRY}/wordpress:svn

  before_script:
    - svn co https://plugins.svn.wordpress.org/stancer svn
    - cd svn


Create archive:
  stage: deploy

  image: ${DOCKER_REGISTRY}/wordpress:php${PHP_VERSION}

  before_script:
    - php -v
    - composer --version
    - pnpm --version

    - pnpm install

  script:
    - pnpm run build:archive
    - if [ -n "$CI_COMMIT_TAG" ]; then export ZIP_NAME="wc-${CI_COMMIT_TAG}"; else ZIP_NAME="wc-${CI_COMMIT_REF_SLUG}"; fi
    - echo "${ZIP_NAME}"
    - mv stancer*.zip "${ZIP_NAME}.zip"

  artifacts:
    paths:
      - '*.zip'


phpcs:
  stage: test

  image: ${DOCKER_REGISTRY}/php:${PHP_VERSION}

  before_script:
    - php -v
    - composer --version

    - composer install
    - ./vendor/bin/phpcs --config-set installed_paths vendor/wp-coding-standards/wpcs/WordPress,vendor/wp-coding-standards/wpcs/WordPress-Core,vendor/wp-coding-standards/wpcs/WordPress-Docs,vendor/wp-coding-standards/wpcs/WordPress-Extra

  script:
    - ./vendor/bin/phpcs || true
    - ./vendor/bin/phpcs --report=junit --report-file=phpcs.junit.xml

  artifacts:
    reports:
      junit: phpcs.junit.xml


Publish main changes:
  extends:
    - .svn-publish

  script:
    - unzip -o ../*.zip -d trunk
    - svn add trunk/*
    - svn up
    - svn stat
    - svn ci -m "$CI_COMMIT_TITLE" --username "$SVN_USER" --password "$SVN_PASSWD"

  needs:
    - job: Create archive
      artifacts: true

  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $SVN_USER && $SVN_PASSWD


Publish version:
  extends:
    - .svn-publish

  script:
    - svn cp trunk "tags/${CI_COMMIT_TAG}"
    - svn ci -m "Version ${CI_COMMIT_TAG}" --username "$SVN_USER" --password "$SVN_PASSWD"

  rules:
    - if: $SVN_USER && $SVN_PASSWD && $CI_COMMIT_TAG
